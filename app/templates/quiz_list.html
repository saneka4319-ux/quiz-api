{% extends "base.html" %}

{% block title %}–ú–æ–∏ —Ç–µ—Å—Ç—ã ‚Äî Quiz API{% endblock %}

{% block content %}

<div style="text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: #252525; border-radius: 8px;">
  <h1 style="color: var(--primary); margin-bottom: 0.5rem;">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ username }}!</h1>
  <p style="color: #aaa; margin-bottom: 0.5rem;">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–µ—Å—Ç—ã, –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –∏—Ö –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
  <a href="/profile" class="btn btn-outline" style="margin-top: 0.5rem;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
</div>

<!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
<div class="card" style="margin-top: 1.5rem; background: #252525;">
  <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç</h3>
  <form id="quizForm" method="POST" action="/quizzes/create" style="margin-top: 1rem;">
    <div class="field">
      <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</label>
      <input type="text" id="title" name="title" required>
    </div>
    <div class="field">
      <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="description" name="description" rows="2"></textarea>
    </div>

    <h4 style="margin-top: 1.5rem; color: var(--primary);">–í–æ–ø—Ä–æ—Å—ã</h4>
    <div id="questions-container">
    </div>
    <button type="button" id="add-question-btn" class="btn btn-outline">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
    <br><br>
    <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button>
    <div id="form-error" class="error" style="margin-top: 0.5rem; display: none;"></div>
  </form>
</div>

{% if request.query_params.get("success") %}
  <div class="success" style="color: #4caf50; margin-bottom: 1rem;">‚úÖ {{ request.query_params.get("success") }}</div>
{% endif %}
{% if request.query_params.get("error") %}
  <div class="error" style="margin-bottom: 1rem;">‚ùå {{ request.query_params.get("error") }}</div>
{% endif %}

<h3 style="margin-top: 2rem;">–ú–æ–∏ —Ç–µ—Å—Ç—ã ({{ quizzes|length }})</h3>

{% if quizzes %}
  {% for quiz in quizzes %}
    <div class="quiz-item">
      <div class="quiz-title">{{ quiz.title }}</div>
      {% if quiz.description %}
        <div class="quiz-desc">{{ quiz.description }}</div>
      {% endif %}
      <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
        <a href="/quizzes/{{ quiz.id }}/take" class="btn btn-outline" style="font-size: 0.9rem;">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</a>
        <form action="/quizzes/{{ quiz.id }}/delete" method="post" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç ¬´{{ quiz.title }}¬ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')">
          <button type="submit" class="btn" style="background: #f44336; font-size: 0.9rem;">–£–¥–∞–ª–∏—Ç—å</button>
        </form>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p style="color: #888; margin-top: 1rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞.</p>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  let questions = [];
  const formError = document.getElementById('form-error');
  const form = document.getElementById('quizForm');
  
  function saveFormData() {
    document.querySelectorAll('.question-card').forEach((card, qIndex) => {
      if (!questions[qIndex]) return;
      
      const questionInput = card.querySelector('input[name^="questions"][name$="[text]"]');
      if (questionInput) {
        questions[qIndex].text = questionInput.value;
      }
      
      const optionItems = card.querySelectorAll('.option-item');
      optionItems.forEach((optionItem, optIndex) => {
        if (!questions[qIndex].options[optIndex]) return;
        
        const textInput = optionItem.querySelector('input[type="text"]');
        const checkbox = optionItem.querySelector('.correct-checkbox');
        
        if (textInput) {
          questions[qIndex].options[optIndex].text = textInput.value;
        }
        if (checkbox) {
          questions[qIndex].options[optIndex].is_correct = checkbox.checked;
        }
      });
    });
    
    localStorage.setItem('quizBuilderState', JSON.stringify(questions));
  }
  
  function restoreFormData() {
    document.querySelectorAll('.question-card').forEach((card, qIndex) => {
      if (!questions[qIndex]) return;
      
      const questionInput = card.querySelector('input[name^="questions"][name$="[text]"]');
      if (questionInput && questions[qIndex].text) {
        questionInput.value = questions[qIndex].text;
      }
      
      const optionItems = card.querySelectorAll('.option-item');
      optionItems.forEach((optionItem, optIndex) => {
        if (!questions[qIndex].options[optIndex]) return;
        
        const textInput = optionItem.querySelector('input[type="text"]');
        const checkbox = optionItem.querySelector('.correct-checkbox');
        
        if (textInput && questions[qIndex].options[optIndex].text) {
          textInput.value = questions[qIndex].options[optIndex].text;
        }
        if (checkbox) {
          checkbox.checked = questions[qIndex].options[optIndex].is_correct;
        }
      });
    });
  }
  document.addEventListener('click', function(event) {
    if (event.target.tagName === 'BUTTON' && event.target.type !== 'submit') {
      event.preventDefault();
    }
    
    if (event.target.id === 'add-question-btn') {
      saveFormData();
      addQuestion();
      return;
    }
    
    if (event.target.closest('[data-action="remove-question"]')) {
      const button = event.target.closest('[data-action="remove-question"]');
      const index = parseInt(button.dataset.index);
      saveFormData();
      removeQuestion(index);
      return;
    }

    if (event.target.closest('[data-action="add-option"]')) {
      const button = event.target.closest('[data-action="add-option"]');
      const qIndex = parseInt(button.dataset.qindex);
      saveFormData();
      addOption(qIndex);
      return;
    }
  });
  
  document.addEventListener('input', function(event) {
    if (event.target.matches('input[type="text"], textarea')) {
      clearTimeout(window.typingTimer);
      window.typingTimer = setTimeout(saveFormData, 300);
    }
  });
  
  document.addEventListener('change', function(event) {
    if (event.target.classList.contains('correct-checkbox')) {
      saveFormData();
      validateQuestion(event);
    }
  });
  
  if (form) {
    form.addEventListener('submit', function(event) {
      saveFormData();
      if (!validateForm()) {
        event.preventDefault();
      } else {
        localStorage.removeItem('quizBuilderState');
      }
    });
  }
  
  function renderQuestions() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    
    questions.forEach((question, index) => {
      const questionHtml = `
        <div class="card question-card" style="background: #333; margin-top: 1rem; padding: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <strong>–í–æ–ø—Ä–æ—Å ${index + 1}</strong>
            <button type="button" data-action="remove-question" data-index="${index}" class="btn btn-outline" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">üóëÔ∏è</button>
          </div>
          <div class="field" style="margin-top: 0.5rem;">
            <input type="text" name="questions[${index}][text]" value="${(question.text || '').replace(/"/g, '&quot;')}" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞" required style="width: 100%;">
          </div>
          <div class="field">
            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:</label>
            <div id="options-${index}" class="options-container">
              ${question.options.map((option, optIndex) => `
                <div class="option-item" style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                  <input type="text" name="questions[${index}][options][${optIndex}][text]" value="${(option.text || '').replace(/"/g, '&quot;')}" placeholder="–í–∞—Ä–∏–∞–Ω—Ç ${optIndex + 1}" required>
                  <label><input type="checkbox" name="questions[${index}][options][${optIndex}][is_correct]" class="correct-checkbox" ${option.is_correct ? 'checked' : ''}> –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π</label>
                </div>
              `).join('')}
            </div>
            <button type="button" data-action="add-option" data-qindex="${index}" style="margin-top: 0.3rem; font-size: 0.9rem;" class="btn btn-outline">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
            <div class="question-error" style="color: var(--error); margin-top: 0.3rem; font-size: 0.9rem; display: none;">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!</div>
          </div>
        </div>
      `;
      container.innerHTML += questionHtml;
    });
    
    restoreFormData();
  }
  
  function addQuestion() {
    questions.push({
      text: '',
      options: [{
        text: '',
        is_correct: false
      }]
    });
    renderQuestions();
  }

  function removeQuestion(index) {
    questions.splice(index, 1);
    renderQuestions();
    checkQuestionsEmpty();
  }
  
  function addOption(qIndex) {
    if (!questions[qIndex].options) {
      questions[qIndex].options = [];
    }
    questions[qIndex].options.push({
      text: '',
      is_correct: false
    });
    renderQuestions();

    setTimeout(() => {
      const container = document.getElementById(`options-${qIndex}`);
      if (container) {
        const lastInput = container.querySelector('.option-item:last-child input[type="text"]');
        if (lastInput) lastInput.focus();
      }
    }, 10);
  }
  
  function validateQuestion(event) {
    const checkbox = event.target;
    const questionCard = checkbox.closest('.question-card');
    if (!questionCard) return;
    
    const errorDiv = questionCard.querySelector('.question-error');
    const checkboxes = questionCard.querySelectorAll('.correct-checkbox');
    const hasCorrect = Array.from(checkboxes).some(cb => cb.checked);
    
    if (!hasCorrect) {
      errorDiv.style.display = 'block';
    } else {
      errorDiv.style.display = 'none';
    }
  }

  function validateForm() {
    formError.style.display = 'none';
    let isValid = true;
    
    questions.forEach((question, index) => {
      const hasCorrect = question.options.some(opt => opt.is_correct);
      const card = document.querySelector(`.question-card:nth-child(${index + 1})`);
      if (card && !hasCorrect) {
        const errorDiv = card.querySelector('.question-error');
        if (errorDiv) {
          errorDiv.style.display = 'block';
          isValid = false;
        }
      }
    });
    
    if (!isValid) {
      formError.textContent = '–û—à–∏–±–∫–∞: –í –∫–∞–∂–¥–æ–º –≤–æ–ø—Ä–æ—Å–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!';
      formError.style.display = 'block';
      formError.scrollIntoView({behavior: 'smooth', block: 'center'});
      return false;
    }
    
    return true;
  }
  
  function checkQuestionsEmpty() {
    if (questions.length === 0) {
      addQuestion();
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const savedState = localStorage.getItem('quizBuilderState');
    if (savedState) {
      questions = JSON.parse(savedState);
    } else {
      addQuestion();
    }
    
    renderQuestions();
    
    document.querySelectorAll('button[type="button"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
      });
    });
    
    document.getElementById('title')?.focus();
  });
</script>
{% endblock %}